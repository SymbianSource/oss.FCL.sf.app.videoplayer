#***********************************************************************************
#
# STIF test script file for testing scheduled download.
#
#***********************************************************************************

[StifSettings]
CapsModifier= IptvTestClientApiCapsMod.exe
[EndStifSettings]

[Define]
INCLUDE c:\testframework\VCXDrives.inc
INCLUDE c:\testframework\VCXConsts.inc
INCLUDE c:\testframework\VCXErrors.inc
INCLUDE c:\testframework\VCXServiceManagementApiTest.inc
INCLUDE c:\testframework\VCXServiceUpdating.inc
INCLUDE c:\testframework\VCXServiceNames.inc
INCLUDE c:\testframework\VCXServiceUrls.inc
INCLUDE c:\testframework\VCXScheduledDownload.inc
[Enddefine]

####################
#
# SUBS
#
####################

[Sub Setup]
create VCXTestUtilModule Util
Util IptvLogCaseStart CASEID
Util CreateMobilecrashWatcher

create VCXScheduledDownloadTest schedtest
schedtest Create
schedtest SetPreferredMemory USED_MEMORY
schedtest RemoveAllSchedules
schedtest RemoveAllMedias
schedtest CheckVideoCount 0
[EndSub]


[Sub TearDown]
delete schedtest
pause 1000
Util CheckMobilecrashes
Util IptvLogCaseEnd
delete Util
pause 1000
[EndSub]


[Sub SetSchedule]
create VCXServiceManagementApiTest smtest
smtest Create
smtest UpdateServiceField SYNC USED_SERVICE EFlags SERVICE_FLAGS
smtest UpdateServiceField SYNC USED_SERVICE EScheduleDlTime SCHED_DL_TIME
smtest UpdateServiceField SYNC USED_SERVICE EScheduleDlType SCHED_DL_TYPE SCHED_DL_COUNT
smtest UpdateServiceField SYNC USED_SERVICE EScheduleDlNetwork SCHED_DL_NETWORK
smtest Destroy
delete smtest
[EndSub]


[Sub DeleteServices]
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC
smtest Destroy
delete smtest
pause 2000
[EndSub]


#------------------------------------------------------------------------------------
#
# Setups access points for the tests.
#
#------------------------------------------------------------------------------------
[Test]
title ET20500 Setup access point.

create VCXTestUtilModule Util
// Copies some known 3G AP to "Internet" destination with "Internet" name for the AP.
Util CopyMethod "Internet" "Internet" "Internet"
// Disable connection dialog for "Internet" destination.
Util SetConnectionMethodIntAttribute "Internet" "Internet" 507 2 // 507 is ECmSeamlessnessLevel
delete Util

[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality.
#
#------------------------------------------------------------------------------------
[Test]
title ET20501 Schedule dl night

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20502
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 05 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     ENight
callsub SetSchedule

Util SetSystemTimeToday 05 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality.
#
#------------------------------------------------------------------------------------
[Test]
title ET20502 Schedule dl morning

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20502
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality.
#
#------------------------------------------------------------------------------------
[Test]
title ET20503 Schedule dl noon

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20503
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 12 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     ENoon
callsub SetSchedule

Util SetSystemTimeToday 12 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality.
#
#------------------------------------------------------------------------------------
[Test]
title ET20504 Schedule dl afternoon

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20504
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 17 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EAfternoon
callsub SetSchedule

Util SetSystemTimeToday 17 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality.
#
#------------------------------------------------------------------------------------
[Test]
title ET20505 Schedule dl evening

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20505
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 23 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EEvening
callsub SetSchedule

Util SetSystemTimeToday 23 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# The ECG XML file is missing from server. No videos should be downloaded.
#
#------------------------------------------------------------------------------------
[Test]
title ET20506 Schedule bad service url

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/asdfasdfsdaf"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20506
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMaximumVideoCount 0

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Disk has not enough space. Videos should not be downloaded.
#
#------------------------------------------------------------------------------------
[Test]
title ET20507 Scheduled dl, not enough space

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20507
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST
Util SetDriveFreeSpace C_DRIVE 100000
Util SetDriveFreeSpace E_DRIVE 100000

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 0

allownextresult EDiskFull 
allownextresult KERRDISKFULL 
schedtest CheckError

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Client removes videos and cancels downloads during scheduled download.
#
#------------------------------------------------------------------------------------
[Test]
title ET20508 Remove videos during scheduling

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20508
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted
allowerrorcodes KERRINUSE
allowerrorcodes KERRCORRUPT
allowerrorcodes KERRNOTREADY
schedtest RemoveAllMedias
schedtest CoolDown
schedtest CheckMinimumVideoCount 5
schedtest CheckMaximumVideoCount 10

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# MPX My videos client starts download during scheduled download.
#
#------------------------------------------------------------------------------------
[Test]
title ET20509 Start dl while scheduled dl ongoing

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20509
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted
schedtest Download 3G_AP "http:\/\/193.65.182.78/nokia_vod/wedding.mp4" "mediacharger" "Buran_9o"

schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# The feed has only urls for streaming meadia.
#
#------------------------------------------------------------------------------------
[Test]
title ET20510 Schedule service with streams
// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField  ASYNC SERVICE_3	EAddress   SERVICE_URL_W_STREAMS
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20510
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMaximumVideoCount 0

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Schedules are removed during scheduled download.
#
#------------------------------------------------------------------------------------
[Test]
title ET20511 Schedule, wait for start and remove schedules

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20511
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 2MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted
schedtest RemoveAllSchedules
schedtest CoolDown
schedtest CheckMinimumVideoCount 2

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Service changes during scheduled download.
#
#------------------------------------------------------------------------------------
[Test]
title ET20512 Schedule & edit service

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20512
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted

create VCXServiceManagementApiTest smtest
smtest Create
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS EDesc "Updated Service description"
smtest Destroy
delete smtest

schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test if scheduling works when more videos are added to the scheduled service.
#
#------------------------------------------------------------------------------------
[Test]
title ET20513 Schedule, add videos, schedule

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest AddHardCodedService SYNC SERVICE_3	3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3	EAddress   "http:\/\/193.65.182.78/random/vary_engine.xml"
smtest UpdateServiceField SYNC SERVICE_3	EName      SERVICE_VARYING
smtest UpdateServiceField SYNC SERVICE_VARYING ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20513
var USED_SERVICE SERVICE_VARYING
var USED_MEMORY E_DRIVE
callsub Setup

create VCXTestUtilModule Util2
Util2 SetUsedDestination DEFAULT_DEST
Util2 Download "http:\/\/193.65.182.78/cgi-bin/vary_engine.cgi?video_count1=3&video_index1=0&use_pubdates1=on&refresh_pubdates1=on&video_count2=0&video_index2=5&video_count3=0&video_index3=10&hiddenfield=Secret+Text" "c:\data\iptvenginetesttemp.txt" "mediacharger" "Buran_9o" 3G_AP
waittestclass Util2
delete Util2

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 2

// Change the service and start schedule again

create VCXTestUtilModule Util2
Util2 Download "http:\/\/193.65.182.78/cgi-bin/vary_engine.cgi?video_count1=7&video_index1=0&use_pubdates1=on&refresh_pubdates1=on&video_count2=0&video_index2=5&video_count3=0&video_index3=10&hiddenfield=Secret+Text" "c:\data\iptvenginetesttemp.txt" "mediacharger" "Buran_9o" 3G_AP
waittestclass Util2
delete Util2

Util AdvanceSystemTimeDays 1
Util SetSystemTimeToday 10 50

pause 5000

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 5

Util AdvanceSystemTimeDays -1
callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test if scheduling works when more videos are added to the scheduled service.
#
#------------------------------------------------------------------------------------
[Test]
title ET20514 Schedule, add random videos, schedule

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest AddHardCodedService SYNC SERVICE_3	3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3	EAddress   "http:\/\/193.65.182.78/random/vary_engine.xml"
smtest UpdateServiceField SYNC SERVICE_3	EName      SERVICE_VARYING
smtest UpdateServiceField SYNC SERVICE_VARYING ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20514
var USED_SERVICE SERVICE_VARYING
var USED_MEMORY E_DRIVE
callsub Setup

create VCXTestUtilModule Util2
Util2 SetUsedDestination DEFAULT_DEST
Util2 Download "http:\/\/193.65.182.78/cgi-bin/vary_engine.cgi?video_count1=3&video_index1=0&use_pubdates1=on&refresh_pubdates1=on&video_count2=0&video_index2=5&video_count3=0&video_index3=10&random_videos=on&hiddenfield=Secret+Text" "c:\data\iptvenginetesttemp.txt" "mediacharger" "Buran_9o" 3G_AP
waittestclass Util2

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 2

// Change the service and start schedule again

create VCXTestUtilModule Util2
Util2 Download "http:\/\/193.65.182.78/cgi-bin/vary_engine.cgi?video_count1=7&video_index1=0&use_pubdates1=on&refresh_pubdates1=on&video_count2=0&video_index2=5&video_count3=0&video_index3=10&random_videos=on&hiddenfield=Secret+Text" "c:\data\iptvenginetesttemp.txt" "mediacharger" "Buran_9o" 3G_AP
waittestclass Util2
delete Util2

Util AdvanceSystemTimeDays 1
Util SetSystemTimeToday 10 50

pause 5000

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 5

Util AdvanceSystemTimeDays -1
callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Service is deleted during scheduled download, only few videos should be downloaded.
#
#------------------------------------------------------------------------------------
[Test]
title ET20515 Schedule & delete service

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20515
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted

create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC
smtest Destroy
delete smtest

schedtest CoolDown
schedtest CheckMinimumVideoCount 2

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality.
#
#------------------------------------------------------------------------------------
[Test]
title ET20516 Schedule n/a video service

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   SERVICE_URL_NA_VIDEOS
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20516
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMinimumVideoCount 0

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Service has untypical videos, they should be downloaded.
#
#------------------------------------------------------------------------------------
[Test]
title ET20517 Schedule untypical service

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   SERVICE_URL_UNTYPICAL
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20517
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 5

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Service has flag that connection is not yet approved. Scheduled download should not care about that.
#
#------------------------------------------------------------------------------------
[Test]
title ET20519 Schedule dl, connection not approved

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20519
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Scheduled download is set only to download in home cellular network.
#
#------------------------------------------------------------------------------------
[Test]
title ET20520 Schedule dl, only home cellular network

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20520
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EHomeCellular
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Scheduled download is set only to download in WLAN network.
#
#------------------------------------------------------------------------------------
[Test]
title ET20521 Schedule dl, only WLAN, WLAN IAP 1st in dest

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 WLAN_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList WLAN_AP 1
smtest SetConnectionAllowed WLAN_AP PERMISSION_ALLOWED
smtest Destroy
delete smtest
pause 2000

var CASEID ET20521
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

allowerrorcodes KERRNOTFOUND
Util DeleteDestination "TESTDEST"
pause 1000
Util CreateDestination "TESTDEST"
Util DeleteDestinationAfterwards "TESTDEST"
Util CopyMethod WLAN_AP "WLANAP" "TESTDEST"
Util CopyMethod 3G_AP "3GAP" "TESTDEST"
Util SetMethodPriority "TESTDEST" "WLANAP" 0
Util SetMethodPriority "TESTDEST" "3GAP" 1

Util SetUsedDestination "TESTDEST"

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EWLAN
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Scheduled download is set only to download in WLAN network.
#
#------------------------------------------------------------------------------------
[Test]
title ET20539 Schedule dl, only WLAN, WLAN IAP last in dest

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 WLAN_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList WLAN_AP 1
smtest SetConnectionAllowed WLAN_AP PERMISSION_ALLOWED
smtest Destroy
delete smtest
pause 2000

var CASEID ET20521
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

allowerrorcodes KERRNOTFOUND
Util DeleteDestination "TESTDEST"
pause 1000
Util CreateDestination "TESTDEST"
Util DeleteDestinationAfterwards "TESTDEST"
Util CopyMethod 3G_AP "3GAP1" "TESTDEST"
Util CopyMethod 3G_AP "3GAP2" "TESTDEST"
Util CopyMethod 3G_AP "3GAP3" "TESTDEST"
Util CopyMethod 3G_AP "3GAP4" "TESTDEST"
Util CopyMethod 3G_AP "3GAP5" "TESTDEST"
Util CopyMethod WLAN_AP "WLANAP" "TESTDEST"
Util SetMethodPriority "TESTDEST" "3GAP1" 0
Util SetMethodPriority "TESTDEST" "3GAP2" 1
Util SetMethodPriority "TESTDEST" "3GAP3" 2
Util SetMethodPriority "TESTDEST" "3GAP4" 3
Util SetMethodPriority "TESTDEST" "3GAP5" 4
Util SetMethodPriority "TESTDEST" "WLANAP" 5

Util SetUsedDestination "TESTDEST"

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EWLAN
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckVideoCount 0

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Scheduled download is set off.
#
#------------------------------------------------------------------------------------
[Test]
title ET20522 Schedule dl, scheduling set to manual

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20522
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

Util SetUsedDestination DEFAULT_DEST

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EManual
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMinimumVideoCount 0

// Do scheduling again, now with correct parameters

var SCHED_DL_NETWORK  EAlways
callsub SetSchedule

Util AdvanceSystemTimeDays 1
Util SetSystemTimeToday 10 50

pause 5000

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Scheduled download is set only to download in WLAN network but destination has no WLAN IAP.
# Downloads should not happen.
#
#------------------------------------------------------------------------------------
[Test]
title ET20524 Schedule dl, only WLAN, used dest has no WLAN IAP

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 WLAN_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList WLAN_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20524
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

allowerrorcodes KERRNOTFOUND
Util DeleteDestination "TESTDEST"
pause 1000
Util CreateDestination "TESTDEST"
Util DeleteDestinationAfterwards "TESTDEST"
Util CopyMethod 3G_AP "3GAP" "TESTDEST"
Util SetMethodPriority "TESTDEST" "3GAP" 0

Util SetUsedDestination "TESTDEST"

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EWLAN
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMinimumVideoCount 0

// Do scheduling again, now with correct parameters

allowerrorcodes KERRNOTFOUND
Util DeleteDestination "TESTDEST"
pause 1000
Util CreateDestination "TESTDEST"
Util CopyMethod WLAN_AP "WLAP" "TESTDEST"
Util SetMethodPriority "TESTDEST" "WLAP" 0
Util SetUsedDestination "TESTDEST"

Util AdvanceSystemTimeDays 1
Util SetSystemTimeToday 10 50

pause 5000

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Scheduled download is set to home cellular but destination has only WLAN IAP. Downloads should happen.
#
#------------------------------------------------------------------------------------
[Test]
title ET20525 Schedule dl, only home cellular, used dest has only WLAN

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20525
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

allowerrorcodes KERRNOTFOUND
Util DeleteDestination "TESTDEST"
pause 1000
Util CreateDestination "TESTDEST"
Util DeleteDestinationAfterwards "TESTDEST"
Util CopyMethod WLAN_AP "WLAP" "TESTDEST"
Util SetMethodPriority "TESTDEST" "WLAP" 0

Util SetUsedDestination "TESTDEST"

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EHomeCellular
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality when used destination has no IAPs.
#
#------------------------------------------------------------------------------------
[Test]
title ET20526 Schedule dl, used destination has no IAPs

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20526
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

allowerrorcodes KERRNOTFOUND
Util DeleteDestination "TESTDEST"
pause 1000
Util CreateDestination "TESTDEST"
Util DeleteDestinationAfterwards "TESTDEST"

Util SetUsedDestination "TESTDEST"

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMinimumVideoCount 0

// Do scheduling again, now with correct parameters

Util SetUsedDestination DEFAULT_DEST

Util AdvanceSystemTimeDays 1
Util SetSystemTimeToday 10 50

pause 5000

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality when destination doesn't exist anymore.
#
#------------------------------------------------------------------------------------
[Test]
title ET20527 Schedule dl, destination removed

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20527
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

allowerrorcodes KERRNOTFOUND
Util DeleteDestination "TESTDEST"
pause 1000
Util CreateDestination "TESTDEST"

Util SetUsedDestination "TESTDEST"
Util DeleteDestination "TESTDEST"

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMinimumVideoCount 0

// Do scheduling again, now with correct parameters

Util SetUsedDestination DEFAULT_DEST

Util AdvanceSystemTimeDays 1
Util SetSystemTimeToday 10 50

pause 5000

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 0

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality when used destination is set to always ask.
#
#------------------------------------------------------------------------------------
[Test]
title ET20528 Schedule dl, used destination is always ask

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20528
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

allowerrorcodes KERRNOTFOUND
Util DeleteDestination "TESTDEST"
pause 1000
Util CreateDestination "TESTDEST"

Util SetUsedDestination "TESTDEST"
Util DeleteDestination "TESTDEST"

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMinimumVideoCount 0

// Do scheduling again, now with correct parameters

Util SetUsedDestination DEFAULT_DEST

Util AdvanceSystemTimeDays 1
Util SetSystemTimeToday 10 50

pause 5000

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Test scheduled download functionality when there's no used destination value in cenrep.
#
#------------------------------------------------------------------------------------
[Test]
title ET20529 Schedule dl, no used destination cenrep

// Setup service
create VCXServiceManagementApiTest smtest
smtest Create
smtest DeleteAllServices SYNC

smtest AddHardCodedService SYNC SERVICE_3 3G_AP 1
smtest UpdateServiceField SYNC SERVICE_3  EAddress   "http:\/\/193.65.182.78/scheddl_date2015.xml"
smtest UpdateServiceField SYNC SERVICE_3  EName      SERVICE_SMALLVIDEOS
smtest UpdateServiceField SYNC SERVICE_SMALLVIDEOS ESetIapList 3G_AP 1
smtest Destroy
delete smtest
pause 2000

var CASEID ET20529
var USED_SERVICE SERVICE_SMALLVIDEOS
var USED_MEMORY E_DRIVE
callsub Setup

allowerrorcodes KERRNOTFOUND
Util DeleteUsedDestinationCenRep

Util SetSystemTimeToday 10 50

// EConnectionApproved, EMainService, ESelected = 13
var SERVICE_FLAGS     EConnectionApproved EMainService ESelected
var SCHED_DL_NETWORK  EAlways
var SCHED_DL_TYPE     EIptvTestDownloadAddedAfterLastScheduledDownload
var SCHED_DL_COUNT    0
var SCHED_DL_TIME     EMorning
callsub SetSchedule

Util SetSystemTimeToday 10 59

pause 60000

schedtest CoolDown
schedtest CheckMinimumVideoCount 0

// Do scheduling again, now with correct parameters

Util SetUsedDestination DEFAULT_DEST

Util AdvanceSystemTimeDays 1
Util SetSystemTimeToday 10 50

pause 5000

Util SetSystemTimeToday 10 58

schedtest WaitForMessages 5MINUTES EVCXTestVideoDownloadStarted
schedtest CoolDown
schedtest CheckMinimumVideoCount 7

callsub TearDown
[Endtest]

#------------------------------------------------------------------------------------
#
# Testname: ET20599 <not a test> Cleanup
#
#------------------------------------------------------------------------------------
[Test]
title ET20599 <not a test> Cleanup

create VCXScheduledDownloadTest schedtest
schedtest Create
schedtest RemoveAllSchedules
schedtest RemoveAllMedias
delete schedtest

callsub Setup
callsub TearDown
[Endtest]
